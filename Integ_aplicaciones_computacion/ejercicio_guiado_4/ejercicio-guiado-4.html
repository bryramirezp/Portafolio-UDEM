<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejercicio Guiado 4 - Autenticación JWT - Portafolio UDEM</title>

    <!-- CSS obligatorio - IMPORTANTE: Este orden -->
    <link rel="stylesheet" href="../../assets/css/neo-brutalist.css">
    <link rel="stylesheet" href="../../assets/css/style.css">

    <!-- Fuentes requeridas -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue:wght@400&family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Mermaid.js para diagramas -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- D3.js para drag and zoom -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                background: '#ffffff',
                primaryColor: '#FFD166',
                primaryTextColor: '#073B4C',
                primaryBorderColor: '#073B4C',
                lineColor: '#073B4C',
                secondaryColor: '#F5F5F5',
                tertiaryColor: '#FFFFFF'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            stateDiagram: {
                useMaxWidth: true,
                htmlLabels: true
            },
            sequenceDiagram: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });
    </script>

    <style>
        /* Mermaid container styling */
        .mermaid-container {
            position: relative;
            border: 2px solid #073B4C;
            border-radius: 4px;
            padding: 10px;
            margin: 20px auto;
            width: 100%;
            max-width: 1200px; /* Increased from 100% to 1200px for larger diagrams */
            background: #fff;
        }

        .mermaid {
            overflow: hidden;
            /* Se establece una altura máxima inicial para que no ocupe toda la pantalla */
            max-height: 600px; 
            display: flex;
            justify-content: center;
        }

        .mermaid svg {
            cursor: grab;
            max-width: 100%; /* Asegura que el SVG no se desborde horizontalmente */
        }

        .mermaid svg:active {
            cursor: grabbing;
        }


        /* Control buttons */
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            gap: 5px;
        }

        .controls button {
            background: #FFD166;
            border: 2px solid #073B4C;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            color: #073B4C;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .controls button:hover {
            background: #073B4C;
            color: #FFD166;
            transform: translate(-1px, -1px);
        }

        /* Fullscreen container */
        .mermaid-container.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important; /* Use viewport width */
            height: 100vh !important; /* Use viewport height */
            background: #ffffff; /* Changed to white */
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            border: none !important;
            margin: 0 !important;
            padding: 20px !important;
        }
        
        /* En modo fullscreen, el mermaid y el svg usan todo el espacio */
        .mermaid-container.fullscreen .mermaid {
            max-height: 100%;
            width: 100%;
            height: 100%;
        }

        .mermaid-container.fullscreen .controls {
            top: 20px;
            right: 20px;
            color: black; /* Changed to black for contrast on white background */
        }

        .mermaid-container.fullscreen .mermaid svg {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain; /* Ensures diagram fits without distortion */
        }


        /* Video container styling */
        .video-container {
            border-radius: 10px;
            overflow: hidden;
            max-width: 560px;
            margin: 20px auto;
            position: relative;
        }

        .video-container iframe {
            width: 100%;
            height: 315px;
            border: none;
            display: block;
        }

        /* Additional wrapper to ensure proper clipping */
        .video-wrapper {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
    </style>
</head>
<body>

    <!-- Header Neo Brutalist -->
    <header class="neo-header">
        <div class="neo-header__left">
            <a href="../ejercicios-guiados.html" class="neo-button neo-button--secondary">← Volver</a>
        </div>
        <div class="neo-header__center">
            <h1 class="neo-header__title">Ejercicio Guiado 4</h1>
            <p class="neo-header__subtitle">Autenticación JWT en Microservicios</p>
        </div>
        <div class="neo-header__right">
            <!-- Toggle se agrega automáticamente por JS -->
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="neo-container" style="padding: 3rem 0;">
        <!-- Nota sobre PredictHealth -->
        <div class="neo-card" style="max-width:900px; margin:0 auto 3rem;">
    <div class="neo-card__title">Implementación en Proyecto PredictHealth</div>
    <div class="neo-card__content">
        <p>
            En lugar de desarrollar la actividad como un microservicio independiente, se integró directamente dentro del proyecto final 
            <strong>PredictHealth</strong>, aprovechando la arquitectura existente de microservicios. Esta implementación centraliza la autenticación 
            y gestión segura de sesiones mediante <strong>JWT (JSON Web Token)</strong> a través del microservicio 
            <strong>AUTH-JWT</strong>, gestionado por el <strong>API Gateway Backend-Flask</strong>, garantizando seguridad y control de acceso para los usuarios.
        </p>
        <p>
            Se utilizó este enfoque siguiendo los requerimientos originales de la actividad: desarrollar un microservicio en Flask que permita 
            registrar usuarios, iniciar sesión, generar y validar tokens JWT, proteger rutas de la API y gestionar el ciclo de vida del token. 
            Además, se implementó el almacenamiento del token en el cliente y el envío en las cabeceras de cada petición, así como el registro 
            de logs en servidor y cliente para monitorear el flujo de autenticación.
        </p>
    </div>
</div>

        <!-- Explicación de la actividad -->
        <h2 style="text-align: center; margin-bottom: 2rem;">Descripción de la Actividad</h2>

        <div class="neo-card" style="max-width: 900px; margin: 0 auto 3rem;">
            <div class="neo-card__title">Microservicio Flask con JWT</div>
            <div class="neo-card__content">
                <p>La actividad central consiste en desarrollar un microservicio en <strong>Flask</strong> que implemente autenticación utilizando <strong>JWT (JSON Web Token)</strong>. Este sistema está diseñado para autenticar usuarios contra una base de datos, cumpliendo con los siguientes requisitos principales:</p>
                <ul>
                    <li><strong>Gestión de Usuarios:</strong> Permitir el registro de nuevos usuarios y el inicio de sesión para usuarios existentes.</li>
                    <li><strong>Generación de Tokens:</strong> Al autenticarse correctamente, el microservicio debe generar y emitir tokens JWT.</li>
                    <li><strong>Protección de Rutas:</strong> Implementar mecanismos para proteger las rutas de la API, asegurando que solo puedan ser accedidas con un token JWT válido y activo.</li>
                    <li><strong>Aplicación Cliente Web:</strong> Crear una aplicación web frontend (HTML, CSS, JS) separada que consuma este microservicio. Esta aplicación debe ser capaz de almacenar el token recibido en el navegador (ej. localStorage) y enviarlo en las cabeceras de cada petición a las rutas protegidas.</li>
                    <li><strong>Logging Detallado:</strong> Incluir logs robustos tanto en el servidor (Flask) como en el cliente (JavaScript) para permitir la observación y depuración del flujo completo de autenticación.</li>
                </ul>

                <h3>Flujo General de Autenticación JWT</h3>
                <p>El proceso básico de autenticación sigue estos pasos:</p>
                <ol>
                    <li>El usuario envía sus credenciales (ej. email y contraseña) al microservicio de autenticación <strong>Auth-JWT</strong>.</li>
                    <li>El microservicio valida estas credenciales. Si son correctas, genera un JWT (que contiene información del usuario y está firmado criptográficamente) y lo envía al cliente.</li>
                    <li>El cliente recibe el JWT y lo almacena en <strong>localStorage</strong>.</li>
                    <li>Para acceder a recursos protegidos, el cliente incluye el JWT en la cabecera <code>Authorization</code> de cada petición HTTP.</li>
                    <li>El microservicio Backend, el cual funge como <strong>API Gateway</strong>, intercepta la petición, verifica la validez y firma del JWT.</li>
                    <li>Si el token es válido, se permite el acceso al recurso solicitado; de lo contrario, se deniega.</li>
                </ol>
            </div>
        </div>

        <!-- ===== INICIO DEL BLOQUE ACTUALIZADO ===== -->
        <!-- Diagramas Mermaid -->
        <h2 style="text-align: center; margin-bottom: 2rem;">Diagrama de Flujo JWT</h2>
        
        <div class="neo-card" style="max-width: 1200px; margin: 0 auto 3rem;">
            <div class="neo-card__title">Proceso Completo de Autenticación JWT</div>
            <div class="neo-card__content">
                <div class="mermaid-container" id="diagramContainer1">
                    <div class="mermaid" id="diagram1">
                        <!-- Contenido se carga desde el script -->
                    </div>
                    <div class="controls">
                        <button id="fullscreenBtn1">⛶</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ===== FIN DEL BLOQUE ACTUALIZADO ===== -->

        <!-- Video relacionado -->
        <h2 style="text-align: center; margin-bottom: 2rem;">Recursos Adicionales</h2>

        <div class="neo-card" style="max-width: 900px; margin: 0 auto 3rem;">
            <div class="neo-card__title">Video Explicativo</div>
            <div class="neo-card__content">
                <p>Demostración de los comandos principales del servicio JWT: login, verificación, refresco, creación y revocación de tokens, junto con métricas, estado e información del sistema.</p>
                <div style="text-align: center; margin-top: 1rem;">
                    <div class="video-wrapper">
                        <div class="video-container">
                            <iframe src="https://www.youtube.com/embed/m6Sur8ufWL0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer Neo Brutalist -->
    <footer class="neo-footer">
        <div class="neo-footer__center">
            <p class="neo-footer__text">Bryan Ramírez Palacios</p>
        </div>
    </footer>

    <!-- Scripts obligatorios - IMPORTANTE: Este orden -->
    <script src="../../assets/js/neo-brutalist.js"></script>
    <script src="../../assets/js/main.js"></script>

    <!-- ===== INICIO DEL SCRIPT ACTUALIZADO ===== -->
    <script>
        // Función para cargar el contenido del diagrama
        function loadMermaidContent(containerId, content) {
            const container = document.getElementById(containerId);
            if (container) {
                container.textContent = content;
            }
        }

        // Initialize Mermaid and D3.js zoom functionality
        document.addEventListener("DOMContentLoaded", function() {
            // Contenido del nuevo diagrama unificado
            const diagramContent = `sequenceDiagram
    participant C as Cliente
    participant AG as API Gateway
    participant JWT as AUTH-JWT Service
    participant PG as PostgreSQL

    Note over C,PG: 1. AUTENTICACIÓN INICIAL
    C->>AG: POST /auth/login<br/>{email, password}
    AG->>JWT: Validar credenciales
    JWT->>PG: SELECT user WHERE email=?
    PG-->>JWT: User data
    JWT->>JWT: Verificar password<br/>Generar Access Token (15min)<br/>Generar Refresh Token (7 días)
    JWT-->>C: {access_token, refresh_token, user_info}

    Note over C,PG: 2. ACCESO A RECURSOS (Token Válido)
    C->>AG: GET /api/resource<br/>Authorization: Bearer {access_token}
    AG->>AG: Decodificar JWT<br/>Validar firma y expiración
    AG->>JWT: Proxy request + user context
    JWT-->>C: 200 OK + Data

    Note over C,PG: 3. TOKEN EXPIRADO - Renovación Automática
    C->>AG: GET /api/resource<br/>Authorization: Bearer {expired_token}
    AG->>AG: Validar token → exp < now()
    AG-->>C: 401 Token Expired
    
    rect rgb(240, 248, 255)
        Note over C: Cliente detecta expiración
        C->>AG: POST /auth/refresh<br/>{refresh_token}
        AG->>JWT: Validar refresh token
        JWT->>JWT: Verificar firma y exp < 7 días
        
        Note over C,PG: CASO A: Refresh Token Válido (< 7 días)
        JWT->>PG: Verificar usuario activo
        PG-->>JWT: User válido
        JWT->>JWT: Generar nuevo Access Token (15min)
        JWT-->>C: {access_token}
        C->>AG: Reintentar request original<br/>con nuevo token
        AG-->>C: 200 OK + Data
        
        Note over C,PG: CASO B: Refresh Token Expirado (> 7 días)
        JWT-->>C: 401 Session Expired
        Note over C: Redirigir a Login
        C->>AG: POST /auth/login (re-autenticación)
    end

    Note over C,PG: 4. CIERRE DE SESIÓN
    C->>AG: POST /auth/logout<br/>Authorization: Bearer {access_token}
    AG->>JWT: Revocar tokens
    JWT->>JWT: Marcar tokens como inválidos
    JWT-->>C: 200 Logout Success
    Note over C: Eliminar tokens del storage

    Note over C,PG: CICLO DE VIDA DEL TOKEN
    Note over C: Access Token: 15 minutos → Renovación automática<br/>Refresh Token: 7 días → Re-login requerido<br/>Validación: JWT Signature + Expiración`;

            // Cargar el diagrama
            loadMermaidContent('diagram1', diagramContent);

            // Initialize Mermaid with proper configuration
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: true,
                    theme: 'base',
                    themeVariables: {
                        background: '#ffffff',
                        primaryColor: '#FFD166',
                        primaryTextColor: '#073B4C',
                        primaryBorderColor: '#073B4C',
                        lineColor: '#073B4C',
                        secondaryColor: '#F5F5F5',
                        tertiaryColor: '#FFFFFF'
                    },
                    sequenceDiagram: {
                        useMaxWidth: true,
                        htmlLabels: true
                    }
                });

                // Re-initialize mermaid after loading content
                setTimeout(() => {
                    mermaid.init(undefined, document.querySelectorAll('.mermaid'));

                    // Apply D3.js drag and zoom to all mermaid SVGs
                    setTimeout(() => {
                        applyD3Zoom();
                    }, 100);

                    // Initialize controls for the diagram
                    initializeDiagramControls(1);
                }, 100);
            }
        });

        // Mapa para guardar los objetos de zoom por diagrama
        const d3ZoomObjects = {};

        // Apply D3.js drag and zoom to all mermaid SVGs
        function applyD3Zoom() {
            const svgs = d3.selectAll(".mermaid svg");
            svgs.each(function() {
                const svg = d3.select(this);
                const container = svg.node().closest('.mermaid-container');
                const diagramId = container ? container.id : 'default';

                // Envuelve el contenido en un grupo para que el zoom funcione
                svg.html("<g>" + svg.html() + "</g>");
                const inner = svg.select("g");

                // Crea el objeto de zoom
                const zoom = d3.zoom().on("zoom", function(event) {
                    inner.attr("transform", event.transform);
                });

                // Aplica el zoom al SVG
                svg.call(zoom);

                // Guarda el objeto de zoom para su uso posterior
                d3ZoomObjects[diagramId] = zoom;
            });
        }

        // Initialize fullscreen functionality for the diagram
        function initializeDiagramControls(diagramNumber) {
            const diagramContainer = document.getElementById(`diagramContainer${diagramNumber}`);
            const fullscreenBtn = document.getElementById(`fullscreenBtn${diagramNumber}`);

            if (!diagramContainer || !fullscreenBtn) return;

            // Full-screen Toggle
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    diagramContainer.requestFullscreen().catch(err => {
                        console.error(`Error: ${err.message}`);
                    });
                    diagramContainer.classList.add('fullscreen');
                } else {
                    document.exitFullscreen();
                    diagramContainer.classList.remove('fullscreen');
                }
            });

            // Handle fullscreen exit events (ESC key, etc.)
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    // Fullscreen was exited - remove the class from all containers
                    document.querySelectorAll('.mermaid-container.fullscreen').forEach(container => {
                        container.classList.remove('fullscreen');
                    });
                }
            });
        }
    </script>
    <!-- ===== FIN DEL SCRIPT ACTUALIZADO ===== -->

</body>
</html>